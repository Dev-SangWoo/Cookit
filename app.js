const readline = require("readline");
const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

// ğŸ”§ ëª…ë ¹ì¤„ ì¸ìë¡œ ìœ íŠœë¸Œ ë§í¬ ì „ë‹¬ ë°›ê¸°
const passedUrl = process.argv[2];

function startWithUrl(url) {
  try {
    const audioPath = "downloads/audio.mp3";

    // [0] ê¸°ì¡´ mp3 íŒŒì¼ ì‚­ì œ
    if (fs.existsSync(audioPath)) {
      fs.unlinkSync(audioPath);
    }

    // [1] mp3 ë‹¤ìš´ë¡œë“œ
    console.log("\n[1] ì˜¤ë””ì˜¤ë¥¼ ë‹¤ìš´ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...");
    execSync(
      `yt-dlp -x --audio-format mp3 --no-playlist -o "downloads/audio.%(ext)s" "${url}"`,
      { stdio: "inherit" }
    );

    // [2] ìë§‰ í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ
    console.log("\n[2] ìë§‰ í™•ì¸ ì¤‘...");
    const subsRaw = execSync(`yt-dlp --list-subs --no-playlist "${url}"`).toString();
    const hasKoSub = subsRaw.includes("ko");
    const hasAutoGenerated = subsRaw.toLowerCase().includes("auto-generated");
    const hasKoManual = hasKoSub && !hasAutoGenerated;

    if (!fs.existsSync("./yt-dlp_sub")) {
      fs.mkdirSync("./yt-dlp_sub");
    }

    if (hasKoManual) {
      console.log("[2-1] âœ… í•œêµ­ì–´ ìˆ˜ë™ ìë§‰ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤...");
      execSync(
        `yt-dlp --write-sub --sub-lang ko --skip-download --no-playlist -o "yt-dlp_sub/%(title)s.%(ext)s" "${url}"`,
        { stdio: "inherit" }
      );
    } else if (hasKoSub) {
      console.log("[2-1] âŒ ìˆ˜ë™ ìë§‰ ì—†ìŒ â†’ ìë™ ìë§‰ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤...");
      execSync(
        `yt-dlp --write-auto-sub --sub-lang ko --skip-download --no-playlist -o "yt-dlp_sub/%(title)s.%(ext)s" "${url}"`,
        { stdio: "inherit" }
      );
    } else {
      console.log("[2-1] âš ï¸ í•œêµ­ì–´ ìë§‰ ìì²´ê°€ ì—†ìŠµë‹ˆë‹¤. ìë§‰ ë‹¤ìš´ë¡œë“œ ìƒëµ.");
    }

    // [3] OCR ë¶„ì„ ì‹¤í–‰
    console.log("\n[3] ì˜ìƒ ì† ìë§‰ OCR ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");
    execSync(`node ocr_analyze.js "${url}"`, { stdio: "inherit" });

    // [4] Whisper ì‹¤í–‰
    console.log(`\n[4] ì¸ì‹í•  ì˜¤ë””ì˜¤ íŒŒì¼: ${audioPath}`);
    console.log("\n[5] Whisperë¡œ ìŒì„± ì¸ì‹ ì¤‘ì…ë‹ˆë‹¤...\n");
    execSync(`python test_whisper.py "${audioPath}"`, { stdio: "inherit" });

  } catch (err) {
    console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", err.message);
  }
}

if (passedUrl) {
  // ëª…ë ¹ì¤„ ì¸ìê°€ ìˆì„ ê²½ìš° ë°”ë¡œ ì‹¤í–‰
  startWithUrl(passedUrl);
} else {
  // ëª…ë ¹ì¤„ ì¸ìê°€ ì—†ì„ ë•ŒëŠ” ê¸°ì¡´ì²˜ëŸ¼ ì…ë ¥ ë°›ê¸°
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  rl.question("ìœ íŠœë¸Œ ì˜ìƒ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ", function (url) {
    startWithUrl(url);
    rl.close();
  });
}
